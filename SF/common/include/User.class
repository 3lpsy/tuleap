<?php   

//
// CodeX: Breaking Down the Barriers to Source Code Sharing inside Xerox
// Copyright (c) Xerox Corporation, CodeX, 2001-2004. All Rights Reserved
// http://codex.xerox.com
//
// $Id$
//
// Originally written by Marie-Luise Schneider 2005, CodeX Team, Xerox

//require_once('common/include/Error.class');
//require_once('common/include/Permission.class');

//$Language->loadLanguageMsg('include/include');

/*

	User object

	Sets up database results and preferences for a user and abstracts this info
*/


class User {

	//associative array of data from db
	var $data_array;

	//group data row from db. 
	//For each group_id (the user is part of) one array from the user_group table
	var $group_data;

	//tracker permission data
	//for each group_artifact_id (the user is part of) one array from the artifact-perm table
	var $tracker_data;


	function User($id) {
	  $this->fetchData($id);
	}


	/*
		Return database result handle for direct access

		Generall should NOT be used - here for supporting deprecated group.php
	*/
	function fetchData($id) {
	  $sql = "SELECT * FROM user WHERE user_id = $id";
	  $db_res = db_query($sql);
	  if (db_numrows($db_res) != 1) {
	    return;
	  }
	  $this->data_array=db_fetch_array($db_res);
	  

	  $this->group_data=array();
	  $sql = "SELECT * FROM user_group WHERE user_id = $id";
	  $db_res = db_query($sql);
	  if (db_numrows($db_res) > 0) {
	    while ($row = db_fetch_array($db_res)) {
	      $this->group_data[$row['group_id']] = $row;
	    }
	  }

	  
	  $this->tracker_data = array();
	  $sql = "SELECT group_artifact_id, perm_level FROM artifact_perm WHERE user_id = $id";
	  $db_res = db_query($sql);
	  if (db_numrows($db_res) > 0) {
	    while ($row = db_fetch_array($db_res)) {
	      $this->tracker_data[$row['group_artifact_id']] = $row;
	    }
	  }

	} 


	/**
	 * is this user member of group $group_id ??
	 */
	function isMember($group_id,$type=0) {
	  $is_member = array_key_exists($group_id,$this->group_data);
	  if (!$is_member) return false;

	  if ($type === 0) return true;

	  $group_perm = $this->group_data[$group_id];

	  $type=strtoupper($type);

	  switch ($type) {
	    /*
	     list the supported permission types
	    */
	  case 'B1' : {
	    //bug tech
	    return ($group_perm['bug_flags'] == 1 || $group_perm['bug_flags'] == 2);
	    break;
	  }
	  case 'B2' : {
	    //bug admin
	    return ($group_perm['bug_flags'] == 2 || $group_perm['bug_flags'] == 3);
	    break;
	  }
	  case 'P1' : {
	    //pm tech
	    return ($group_perm['project_flags'] == 1 || $group_perm['project_flags'] == 2);
	    break;
	  }
	  case 'P2' : {
	    //pm admin
	    return ($group_perm['project_flags'] == 2 || $group_perm['project_flags'] == 3);
	    break;
	  }
	  case 'C1' : {
	    //patch tech
	    return ($group_perm['patch_flags'] == 1 || $group_perm['patch_flags'] == 2);
	    break;
	  }
	  case 'C2' : {
	    //patch admin
	    return ($group_perm['patch_flags'] == 2 || $group_perm['patch_flags'] == 3);
	    break;
	  }
	  case 'F2' : {
	    //forum admin
	    return ($group_perm['forum_flags'] == 2);
	    break;
	  }
	  case 'S1' : {
	    //support tech
	    return ($group_perm['support_flags'] == 1 || $group_perm['support_flags'] == 2);
	    break;
	  }
	  case 'S2' : {
	    //support admin
	    return ($group_perm['support_flags'] == 2 || $group_perm['support_flags'] == 3);
	    break;
	  }
	  case 'A' : {
	    //admin for this group
	    return ($group_perm['admin_flags'] && $group_perm['admin_flags'] === 'A');
	    break;
	  }
	  case 'D1' : {
	    //document tech
	    return ($group_perm['doc_flags'] == 1 || $group_perm['doc_flags'] == 2);
	    break;
	  }
	  case 'D2' : {
	    //document admin
	    return ($group_perm['doc_flags'] == 2 || $group_perm['doc_flags'] == 3);
	    break;
	  }
	  case 'R2' : {
	    //file release admin
	    return ($group_perm['file_flags'] == 2);
	    break;
	  }
	  case 'W2': {
	    //wiki release admin
	    return ($group_perm['wiki_flags'] == 2);
	    break;
	  }
	  default : {
	    //fubar request
	    return false;
	  }
	  }
	}


	/** is this user admin of the tracker group_artifact_id */
	function isTrackerAdmin($group_id,$group_artifact_id) {
	  return ($this->getTrackerPerm($group_artifact_id) >= 2 || $this->isMember($group_id,'A'));
	}

	/** is this user technician of the tracker group_artifact_id */
	function isTrackerTech($group_id,$group_artifact_id) {
            $perm=$this->getTrackerPerm($group_artifact_id);
	  return ($perm == 1 || $perm == 2 || $this->isMember($group_id,'A'));
	}


	function getTrackerPerm($group_artifact_id) {
	  $has_perm = array_key_exists($group_artifact_id,$this->tracker_data);
	  if (!$has_perm) return 0;

	  $perm = $this->tracker_data[$group_artifact_id];

	  return $perm['perm_level'];
	}


	function isSuperUser() {
	  $sql="SELECT * FROM user_group WHERE user_id='". $this->data_array['user_id'] ."' AND group_id='1' AND admin_flags='A'";
	  $result=db_query($sql);
	  if ($result && db_numrows($result) > 0) {
	    return true;
	  } else {
	    return false;
	  }
	}
}

?>
