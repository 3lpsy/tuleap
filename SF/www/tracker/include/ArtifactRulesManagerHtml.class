<?php
//
// Copyright (c) Xerox Corporation, CodeX Team, 2001-2003. All rights reserved
//
// $Id$
//
//

require_once('common/tracker/ArtifactRulesManager.class');
require_once('ArtifactTypeHtml.class');
$Language->loadLanguageMsg('tracker/tracker');

class ArtifactRulesManagerHtml extends ArtifactRulesManager {

	/**
	 *  ArtifactRulesManagerHtml() - constructor
	 *
	 *  @param $artifact_type object
	 */
	function ArtifactRulesManagerHtml(&$artifact_type_html) {
		$this->ArtifactRulesManager($artifact_type_html);
        $this->artifact_type =& $artifact_type_html;
        
	}
    

    function displayEditForm() {
        $this->_header();
        echo '<noscript>'. $GLOBALS['Language']->getText('tracker_dynamic_fields','noscript') .'</noscript>';
        echo '<h3>'. $GLOBALS['Language']->getText('tracker_include_type','edit_rule') .'</h3>';
        echo '<form action="" method="post"><div id="edit_rule"></div>';
        echo '</form>';
        echo '<script type="text/javascript">'."\n";
        
        $art_field_fact =& new ArtifactFieldFactory($this->artifact_type);
        $used_fields = $art_field_fact->getAllUsedFields();
        foreach($used_fields as $field) {
            if ($field->isSelectBox() || $field->isSelectBox()) {
                $values = $field->getFieldValues ($this->artifact_type->getID(),"'A','P'");
                if (db_numrows($values) > 1) {
                    echo "fields['".$field->getID()."'] = new com.xerox.codex.tracker.Field('".$field->getID()."', '".$field->getLabel()."');\n";
                    $default_value = $field->getDefaultValue();
                    echo "options['".$field->getID()."'] = {};\n";
                    while ($row = db_fetch_array($values)) {
                        echo "options['". $field->getID() ."']['". $row['value_id'] ."'] = {option:new Option('". $row['value'] ."', '". $row['value_id'] ."'), selected:". ($row['value_id']==$default_value?'true':'false') ."};\n";
                    }
                }
            }
        }
        echo "\n//------------------------------------------------------\n";
        echo 'messages = {';
            echo "choose_field:'". $GLOBALS['Language']->getText('tracker_include_type','choose_field') ."',\n";
            echo "if_then:'". $GLOBALS['Language']->getText('tracker_include_type','if_then') ."',\n";
            echo "btn_save_rule:'". $GLOBALS['Language']->getText('tracker_include_type','btn_save_rule') ."'";
        echo "};\n";
        echo 'buildAdminUI();';
        echo "\n//------------------------------------------------------\n";
        echo "\n".'//--><!]]></script>';
        echo '</fieldset>';
        $this->_footer();
    }
    
    function displayRules() {
        $this->_header();
        echo $GLOBALS['Language']->getText('tracker_dynamic_fields','no_dynamic_fields');
        echo '<br />';
        echo $GLOBALS['Language']->getText('tracker_dynamic_fields','add_edit', array($_SERVER['REQUEST_URI'] .'&amp;edit=1'));
        $this->_footer();
    }
    
    function _header() {
        $GLOBALS['HTML']->includeJavascriptFile("/include/scriptaculous/prototype.js");
        $GLOBALS['HTML']->includeJavascriptFile("/include/scriptaculous/scriptaculous.js");
        $GLOBALS['HTML']->includeJavascriptFile("/include/dynamicFields.js");
        
        $params = array();
        $params['title']   = $this->artifact_type->getName() .' '. $GLOBALS['Language']->getText('tracker_include_type','mng_dynamic_fields');
        $params['help']    = 'TrackerAdministration.html';
		$this->artifact_type->adminHeader($params);
        $this->artifact_type->displayAdminTitle($GLOBALS['Language']->getText('tracker_include_type','mng_dynamic_fields_title'));
    }
    
    function _footer() {
        $this->artifact_type->footer(array());
    }
}

?>
