<?php
//
// Copyright (c) Xerox Corporation, CodeX Team, 2001-2003. All rights reserved
//
// $Id$
//
//  Parts of code come from bug_util.php (written by Laurent Julliard)
//
//  Written for CodeX by Stephane Bouhet
//


class ArtifactReportHtml extends ArtifactReport {
        
        /**
         *  Constructor.
         *
         *      @param  report_id       
         *  @param  atid: the artifact type id
         *
         *      @return boolean success.
         */
        function ArtifactReportHtml($report_id,$atid) {
        // echo 'ArtifactReportHtml('.$report_id.','.$atid.')';
                return $this->ArtifactReport($report_id,$atid);
        }
        
        /**
         *      Return the HTML table which displays the priority colors
         *
         *      @param msg: the label of te table
         *
         *      @return string
         */
        function showPriorityColorsKey($msg) {
                $html_result = "";
                
                $html_result .= '<P class="small"><B>'.($msg ? $msg : 'Priority Colors:').'</B><BR><TABLE BORDER=0><TR>';
        
                for ($i=1; $i<10; $i++) {
                        $html_result .=  '<TD class="'.get_priority_color($i).'">'.$i.'</TD>';
                }
                $html_result .=  '</tr></table>';
                
                return $html_result;
        }
        
        /**
         *  Check is a sort criteria is already in the list of comma
         *  separated criterias. If so invert the sort order, if not then
         *  simply add it
         *
         *      @param criteria_list: the criteria list
         *  @param order: the order chosen by the UI
         *  @param msort: if multi sort is activate
         *
         *      @return string
         */
        function addSortCriteria($criteria_list, $order, $msort)
        {
            //echo "<br>DBG \$criteria_list=$criteria_list,\$order=$order";
        
            if ($criteria_list) {
                        $arr = explode(',',$criteria_list);
                        $i = 0;
                        while (list(,$attr) = each($arr)) {
                            preg_match("/\s*([^<>]*)([<>]*)/", $attr,$match);
                            list(,$mattr,$mdir) = $match;
                            //echo "<br>DBG \$mattr=$mattr,\$mdir=$mdir";
                            if ($mattr == $order) {
                                        if ( ($mdir == '>') || (!isset($mdir)) ) {
                                            $arr[$i] = $order.'<';
                                        } else {
                                            $arr[$i] = $order.'>';
                                        }
                                        $found = true;
                            }
                            $i++;
                        }
            }
        
            if (!$found) {
                        if (!$msort) { unset($arr); }
                        $field_order = $this->USAGE_BY_NAME[$order];
                        if ( ($order == 'severity') || ($order == 'hours') || (($field_order)&&($field_order->isDateField())) ) {
                            // severity, effort and dates sorted in descending order by default
                            $arr[] = $order.'<';
                        } else {
                            $arr[] = $order.'>';
                        }
            }
            
            //echo "<br>DBG \$arr[]=".join(',',$arr);
        
            return(join(',', $arr));    
        
        }       

        /**
         * Transform criteria list to readable text statement
         * $url must not contain the morder parameter
         *
         *      @param criteria_list: the criteria list
         *  @param url: HTTP Get variables to add
         *
         *      @return string
         */
        function criteriaListToText($criteria_list, $url) {
                
	  global $art_field_fact;
	  
	  if ($criteria_list) {
	    
	    $arr = explode(',',$criteria_list);
	    
	    while (list(,$crit) = each($arr)) {
	      
	      $morder .= ($morder ? ",".$crit : $crit);
	      $attr = str_replace('>','',$crit);
	      $attr = str_replace('<','',$attr);
	      
	      $field = $art_field_fact->getFieldFromName($attr);
	      if ( $field && $field->isUsed() ) {
		$label = $field->getLabel();
		$arr_text[] = '<a href="'.$url.'&morder='.$morder.'#results">'.
		  $label.'</a><img src="'.util_get_dir_image_theme().
		  ((substr($crit, -1) == '<') ? 'dn' : 'up').
		  '_arrow.png" border="0">';
	      }
	    }
	  }
	  
	  return join(' > ',$arr_text);
        }
        
        /**
         *  Display the HTML code to display the query fields
         *
         *  @param prefs: array of parameters used for the current query
         *  @param advsrch,pv: HTTP get variables
         *
         *      @return string
         *
         */
        function displayQueryFields($prefs,$advsrch,$pv) {
            global $ath;

            //
            // Loop through the list of used fields to define label and fields/boxes
            // used as search criteria
            //
            
            $html_select = "<table width='100%'>";
            
            // Number of search criteria (boxes) displayed in one row
            $fields_per_line=5;

            $ib=0;$is=0;
            $load_cal=false;

            $query_fields = $this->getQueryFields();
            while (list($key,$field) = each($query_fields) ) {
            
                $field_html = new ArtifactFieldHtml($field);
                    
                //echo $field->getName()."-".$field->display_type."-".$field->data_type."-".$field->dump()."<br>";
                                    
                // beginning of a new row
                if ($ib % $fields_per_line == 0) {
                    $align = "center";
                    $labels .= "\n".'<TR align="'.$align.'" valign="top">';
                    $boxes .= "\n".'<TR align="'.$align.'" valign="top">';
                }

                // Need to build help button argument. 
                // Concatenate 3 args in one string
                $group_id = $ath->Group->getID();
                $help_args = $group_id.'|'.$this->group_artifact_id.'|'.$field->getName();
                $labels .= '<td class="small"><b>'.$field->getLabel().'&nbsp;'.
                    help_button('browse_tracker_query_field',$help_args).
                    '</b></td>';
            
                $boxes .= '<TD><FONT SIZE="-1">';
            
                if ( $field->isSelectBox() ) {
    
    				// Check for advanced search if you have the field in the $prefs (HTTP parameters)
    				if ( $advsrch ) {
    					if ( $prefs[$field->getName()] ) {
    						if ( is_array($prefs[$field->getName()]) ) {
    							$values = $prefs[$field->getName()];
    						} else {
    							$values[] = $prefs[$field->getName()];
    						}
    					} else {
							$values[] = 0;
    					}
    				} else {
    					$values = $prefs[$field->getName()][0];
    				}
    			
                    $boxes .= 
                        $field_html->display($this->group_artifact_id,$values,
                                          false,false,($pv?true:false),false,true,'None', true,'Any');
            
                } else if ( $field->isMultiSelectBox() ) {
            
                    $boxes .= 
                        $field_html->display($this->group_artifact_id,
                                          $prefs[$field->getName()],
                                          false,false,($pv?true:false),false,true,'None', true,'Any');
            
                } else if ($field->isDateField() ){
            
                    $load_cal = true; // We need to load the Javascript Calendar
                    if ($advsrch) {
                        $boxes .= $field_html->multipleFieldDate($prefs[$field->getName()][0],
                                                          $prefs[$field->getName().'_end'][0],0,0,$pv);
                    } else {
                        $boxes .= $field_html->fieldDateOperator($prefs[$field->getName().'_op'][0],$pv).
                            $field_html->fieldDate($prefs[$field->getName()][0],$pv);
                    }
                            
                } else if ( $field->isTextField() || 
                           $field->isTextArea() ) {

                    $boxes .= 
                        ($pv ? $prefs[$field->getName()][0] : $field_html->fieldText($prefs[$field->getName()][0],15,80)) ;
            
                }
                $boxes .= "</TD>\n";
            
                $ib++;
            
                // end of this row
                if ($ib % $fields_per_line == 0) {
                    $html_select .= $labels.'</TR>'.$boxes.'</TR>';
                    $labels = $boxes = '';
                }
            
            }
            
            // Make sure the last few cells are in the table
            if ($labels) {
                $html_select .= $labels.'</TR>'.$boxes.'</TR>';
            }
            
            $html_select .= "</table>";
            
            return $html_select;

        }


        /**
         *  Return the HTML code to display the results of the query fields
         *
         *  @param group_id: the group id
         *  @param prefs: array of parameters used for the current query
         *  @param total_rows: number of rows of the result
         *  @param url: HTTP Get variables to add
         *  @param nolink: link to detailartifact
         *  @param offset,chunksz,morder,advsrch,offset,chunksz: HTTP get variables
         *
         *      @return string
         *
         */
        function showResult ($group_id,$prefs,$offset,$total_rows,$url,$nolink,$chunksz,$morder,$advsrch,$chunksz,$masschange=false) {
            global $PHP_SELF;
            global $ath;

            $html_result = "";
        
            // Build the list of links to use for column headings
            // Used to trigger sort on that column
            $result_fields = $this->getResultFields();      
            
            $links_arr = array();
            $title_arr = array();
            $width_arr = array();

            if ( count($result_fields) == 0 ) return;

            reset($result_fields);
            while (list(,$field) = each($result_fields)) {
                $links_arr[] = $url.'&order='.$field->getName().'#results';
                $title_arr[] = $field->getLabel();
                $width_arr[$field->getName()] = $field->getColWidth();
            }

            $query = $this->createQueryReport($prefs,$morder,$advsrch,$offset,$chunksz);
            $result = $this->getResultQueryReport($query);
            $rows = count($result);
                    
           /*
              Show extra rows for <-- Prev / Next -->
            */  
            $nav_bar ='<table width= "100%"><tr>';
            $nav_bar .= '<td width="40%" align ="left">';
        
            // If all artifacts on screen so no prev/begin pointer at all
            if ($total_rows > $chunksz) {
                if ($offset > 0) {
                    $nav_bar .=
                    '<A HREF="'.$url.'&offset=0#results" class="small"><B>&lt;&lt; Begin</B></A>'.
                    '&nbsp;&nbsp;&nbsp;'.
                    '<A HREF="'.$url.'&offset='.($offset-$chunksz).
                    '#results" class="small"><B>&lt; Previous '.$chunksz.'</B></A></td>';
                } else {
                    $nav_bar .=
                        '<span class="disable">&lt;&lt; Begin&nbsp;&nbsp;&lt; Previous '.$chunksz.'</span>';
                }
            }
        
            $nav_bar .= '</td>';
            
            $offset_last = min($offset+$chunksz-1, $total_rows-1);
        
            $nav_bar .= '<td width= "20% " align = "center" class="small">Items '.($offset+1).' - '.
                ($offset_last+1)."</td>\n";
        
            $nav_bar .= '<td width="40%" align ="right">';
        
            // If all artifacts on screen, no next/end pointer at all
            if ($total_rows > $chunksz) {
                if ( ($offset+$chunksz) < $total_rows ) {
        
                    $offset_end = ($total_rows - ($total_rows % $chunksz));
                    if ($offset_end == $total_rows) { $offset_end -= $chunksz; }
        
                    $nav_bar .= 
                        '<A HREF="'.$url.'&offset='.($offset+$chunksz).
                        '#results" class="small"><B>Next '.$chunksz.' &gt;</B></A>'.
                        '&nbsp;&nbsp;&nbsp;'.
                        '<A HREF="'.$url.'&offset='.($offset_end).
                        '#results" class="small"><B>End &gt;&gt;</B></A></td>';
                } else {
                    $nav_bar .= 
                        '<span class="disable">Next '.$chunksz.
                        ' &gt;&nbsp;&nbsp;End &gt;&gt;</span>';
                }
            }
            $nav_bar .= '</td>';
            $nav_bar .="</tr></table>\n";
         
            $html_result .= $nav_bar;



	    if ($masschange) {
               	$html_result .= '<FORM NAME="artifact_list" action="'.$PHP_SELF.'" METHOD="POST">';
               	$html_result .= html_build_list_table_top ($title_arr,$links_arr,true);
            } else {
               	$html_result .= html_build_list_table_top ($title_arr,$links_arr);
            }

        
                
            for ($i=0; $i < $rows ; $i++) {
        
                $html_result .= '<TR class="'.get_priority_color($result[$i]['severity_id']) .'">'."\n";

                if ($masschange) {
                        $html_result .= '<TD align="center"><INPUT TYPE="checkbox" name="mass_change_ids[]" value="'.$result[$i]['artifact_id'].'"></td>';
                }

                reset($result_fields);  
                while (list($key,$field) = each($result_fields) ) {
                    //echo "$key=".$result[$i][$key]."<br>";
                                    
				    $value = $result[$i][$key];
				    if ($width_arr[$key]) {
						$width = 'WIDTH="'.$width_arr[$key].'%"';
				    } else {
						$width = '';
				    }
				    $width .= ' class="small"';
				    
				    if ( $field->isDateField() ) {
						if ($value)
						    $html_result .= "<TD $width>".format_date("Y-m-d",$value).'</TD>'."\n";
						else
						    $html_result .= "<TD align=\"center\">-</TD>\n";
	
				    } else if ($field->getName() == 'artifact_id') {
						if ($nolink) 
						    $html_result .= "<TD $width>$value</TD>\n";
						else
						    $html_result .= "<TD $width>".'<A HREF="/tracker/?func=detail&aid='.
						$value.'&atid='.$this->group_artifact_id.'&group_id='.$group_id.'">'. 
						$value .'</A></TD>'."\n";
	                        
				    } else if ( $field->isUsername() ) {        
						if ($nolink)
						    $html_result .= "<TD $width>$value</TD>\n";
						else
						    $html_result .= "<TD $width>".util_multi_user_link($value)."</TD>\n";
					
					} else if ( $field->isFloat() ) {
						$html_result .= "<TD $width>". number_format($value,2) .'&nbsp;</TD>'."\n";
					} else {
						$html_result .= "<TD $width>". $value .'&nbsp;</TD>'."\n";
				    }                            
                                
                } // while 
                $html_result .= "</tr>\n";
            }
        
            $html_result .= '</TABLE>';

            if ($masschange) {
               	$html_result .= '
       <script language="JavaScript">
       <!--
              function checkAll(val) {
                       al=document.artifact_list;
                       len = al.elements.length;
                       var i=0;
                       for( i=0 ; i<len ; i++) {
                               if (al.elements[i].name==\'mass_change_ids[]\') {al.elements[i].checked=val;}
                      }
               }
       //-->
       </script>';

		$html_result .= '<INPUT TYPE="HIDDEN" NAME="atid" VALUE="'.$this->group_artifact_id.'">
                          <INPUT TYPE="HIDDEN" NAME="group_id" VALUE="'.$group_id.'">
                          <INPUT TYPE="HIDDEN" NAME="report_id" VALUE="'.$this->report_id.'">
                          <INPUT TYPE="HIDDEN" NAME="func" VALUE="masschange_detail">';
		// get the query
		while (list($field,$value) = each($prefs) ) {
			if (is_array($value)) {
				while (list(,$val) = each($value)) {
					$html_result .= '<INPUT TYPE="HIDDEN" NAME="'.$field.'[]" VALUE="'.$val.'">';	
				}
			} else {
				$html_result .= '<INPUT TYPE="HIDDEN" NAME="'.$field.'" VALUE="'.$value.'">';
			}
		}
		if ($total_rows > $chunksz) {
               		$html_result .=
           	    	'<a href="javascript:checkAll(1)">Check items '.($offset+1).'-'.($offset_last+1).'</a>'.
               		' - <a href="javascript:checkAll(0)">Clear items '.($offset+1).'-'.($offset_last+1).'</a><p>';
		
	      	 	$html_result .= '<table width= "100%"><tr><td width="50%" align ="center" class="small">';
			$html_result .= '<INPUT TYPE="SUBMIT" NAME="submit" VALUE="Mass Change Selected Items (from '.($offset+1).'-'.($offset_last+1).')">';
			$html_result .= '</td><td width="50%" align ="center" class="small">';
			$html_result .= '<INPUT TYPE="SUBMIT" NAME="submit" VALUE="Mass Change All Items ('.$total_rows.' matches)">';
			$html_result .= '</td></tr></table>';
		} else {
			$html_result .=
           	    	'<a href="javascript:checkAll(1)">Check all items</a>'.
               		' - <a href="javascript:checkAll(0)">Clear all items </a><p>';
		
			$html_result .= '<table width= "100%"><tr><td width="60%" align ="center" class="small">';
			$html_result .= '<INPUT TYPE="SUBMIT" NAME="submit" VALUE="Mass Change Selected Items (from 1-'.$total_rows.')">';
			$html_result .= '</td></tr></table>';
		}
		$html_result .= '</FORM>';
            } else {
               	$html_result .= $nav_bar;
            }

            
            return $html_result;
        }

        /**
         *  Display the report
         *
         *  @param prefs: array of parameters used for the current query
         *  @param group_id,report_id,set,advsrch,msort,morder,order,pref_stg,offset,chunksz,pv: HTTP get variables
         *
         *      @return string
         *
         */
        function displayReport($prefs,$group_id,$report_id,$set,$advsrch,$msort,$morder,$order,$pref_stg,$offset,$chunksz,$pv,$masschange=false) {
                
                global $ath,$art_field_fact;
                
        $html_result = "<script language=\"JavaScript\" src=\"/include/calendar.js\"></script>\n";

                // Display browse informations if any
                if ( $ath->getBrowseInstructions() ) {
                        $html_result .= $ath->getBrowseInstructions();
                }
                
                $html_result .= '
                          <FORM ACTION="'.$PHP_SELF.'" METHOD="GET" NAME="artifact_form">
                          <INPUT TYPE="HIDDEN" NAME="atid" VALUE="'.$this->group_artifact_id.'">
                          <INPUT TYPE="HIDDEN" NAME="group_id" VALUE="'.$group_id.'">';
		if ($masschange) {
                          $html_result .= ' 
			  <INPUT TYPE="HIDDEN" NAME="func" VALUE="masschange">';
		} else {
			  $html_result .= '
			  <INPUT TYPE="HIDDEN" NAME="func" VALUE="browse">';
		}

                $html_result .= '
			  <INPUT TYPE="HIDDEN" NAME="set" VALUE="custom">
                          <INPUT TYPE="HIDDEN" NAME="advsrch" VALUE="'.$advsrch.'">
                          <INPUT TYPE="HIDDEN" NAME="msort" VALUE="'.$msort.'">
			  <TABLE BORDER="0" CELLPADDING="0" CELLSPACING="5">
                          <TR><TD colspan="'.$fields_per_line.'" nowrap>'.
                     ($pv ? '<h3>Selected '.$ath->getCapsItemName().'</h3>':'<h3>Browse '.$ath->getCapsItemName());
                
                //Show the list of available artifact reports
                if (!$pv) {
                    $res_report = $this->getReports($this->group_artifact_id,user_getid());
                    $box_name = 'report_id" onChange="document.artifact_form.go_report.click()';

                        $html_result .= ' using report '.
                                html_build_select_box($res_report,$box_name,$report_id,false).
                                '<input VALUE="Go" NAME="go_report" type="submit">';
                }
                
                // Start building the URL that we use to for hyperlink in the form
		if ($masschange) {
                	$url = "/tracker/?atid=".$this->group_artifact_id."&group_id=$group_id&func=masschange&set=$set&msort=$msort";
		} else {
			$url = "/tracker/?atid=".$this->group_artifact_id."&group_id=$group_id&func=browse&set=$set&msort=$msort";
		} 
                if ($set == 'custom')
                     $url .= $pref_stg;
                else
                     $url .= '&advsrch='.$advsrch;
                
                $url_nomorder = $url;
                $url .= "&morder=$morder";
                
                // Build the URL for alternate Search
                if ($advsrch) { 
                    $url_alternate_search = str_replace('advsrch=1','advsrch=0',$url);
                    $text = 'Simple Search';
                } else {    
                    $url_alternate_search = str_replace('advsrch=0','advsrch=1',$url); 
                    $text = 'Advanced Search';
                }
                
                if (!$pv) {
                     $html_result .= '<small>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(or use <a href="'.
                         $url_alternate_search.'">'.$text.'</a>)</small></h3><p>';
                }
                
                $html_result .= $html_select;
                
                $html_result .= '</TABLE>';

                // Display query fields
                $html_result .= $this->displayQueryFields($prefs,$advsrch,$pv);
                
                if (!$pv) {
                    $html_result .= '<p><FONT SIZE="-1"><INPUT TYPE="SUBMIT" NAME="SUBMIT" VALUE="Browse"></FONT> '.
                        '<input TYPE="text" name="chunksz" size="3" MAXLENGTH="5" '.
                        'VALUE="'.$chunksz.'">'.$ath->getItemName().'s at once.</FORM>';
                }
                
                //
                // Finally display the result table
                // 
                
                $totalrows = $this->getReportItemsCount($prefs,$morder,$advsrch);

                if ($totalrows > 0) {
                
                    // Build the sorting header messages
                    if ( $morder ) {
                                $order_statement = 'sorted by '.($pv ? '':help_button('ArtifactBrowsing.html#ArtifactListSorting',false)).
                                    ' : '.$this->criteriaListToText($morder, $url_nomorder);
                    } else {
                                $order_statement ='';
                    }
                    
                    $html_result .= '<A name="results"></A>';
                    $html_result .= '<h3>'.$totalrows.' matching '.$ath->getItemName().($totalrows>1 ? 's':'').' '.
                        $order_statement.'</h3>';
                
                    if (!$pv) {
                                $html_result .= '<P>Click a column heading to sort results (up or down), ';
                                $field = $art_field_fact->getFieldFromName('severity');
                                if ( $field && $field->isUsed()) {
                                        $html_result .= 'or <A HREF="'.$url.'&order=severity#results"><b>Sort by Severity</b></A> ';
                                }
                                $html_result .= 'or <A HREF="'.$url.'&order=#results"><b>Reset sort</b></a>. ';
                        }
                    
                    if ($msort) { 
                                $url_alternate_sort = str_replace('msort=1','msort=0',$url).
                                    '&order=#results';
                                $text = 'Deactivate';
                    } else {    
                                $url_alternate_sort = str_replace('msort=0','msort=1',$url).
                            '&order=#results';
                                $text = 'Activate';
                    }
                
                    if (!$pv) {
                                $html_result .= 'You can also <a href="'.$url_alternate_sort.'"><b> '.$text.
                                    ' multicolumn sort</b></a>.&nbsp;&nbsp;&nbsp;&nbsp;'.
                                    '(<a href="'.$url.'&pv=1"> <img src="'.util_get_image_theme("msg.png").'" border="0">'.
                                    '&nbsp;Printer version</a>)'."\n";
                    }
                
                    if ($pv) { $chunksz = 100000; }
                    $html_result .= $this->showResult($group_id,$prefs,$offset,$totalrows,($pv ? '' : $url), ($pv ? true:false) ,$chunksz ,$morder,$advsrch,$chunksz,$masschange);
                    $html_result .= $this->showPriorityColorsKey('Severity colors:');
                
                } else {
                
                    $html_result .= "<H2>No Matching ".$ath->getCapsItemName()." Found for ".group_getname($group_id)." or filters too restrictive</H2>";
                    $html_result .= db_error();
                
                }
        
                echo $html_result;
                
                //return $html_result;
        }

        /**
         * Return a label for the scope code
         *
         * param scope: the scope code
         *
         * @return string
         */
        function getScopeLabel($scope) {
            switch ( $scope ) {
            case 'P':
                return 'Project';
            case 'I':
                return 'Personal';
            case 'S':
                return 'System';
            }
        }                   

        /**
         * Display the report list
         *
         * param : $reports      the list the reports within an artifact to display
         *
         * @return void
         */
        function showAvailableReports($reports) {
                global $ath;
                
                $g = $ath->getGroup();
                $group_id = $g->getID();
                $atid = $ath->getID();

                $ath->adminHeader(array ('title'=>'Artifact Administration - Tracker Report Management',
                                    'help' => 'TrackerAdministration.html#TrackerReportManagement'));
                $trackerName = $ath->getName();
        
                echo '<H2>Tracker \'<a href="/tracker/admin/?group_id='.$group_id.'&atid='.$atid.'">'.$ath->getName().'</a>\'  - Reports Administration</H2>';
                
                 if ($reports) {
                // Loop through the list of all artifact report
                $title_arr=array();
                $title_arr[]='ID';
                $title_arr[]='Report name';
                $title_arr[]='Description';
                $title_arr[]='Scope';
                $title_arr[]='Delete?';
                
                echo '<p>(Click to modify)';
                echo html_build_list_table_top ($title_arr);
                $i=0;
                while ($arr = db_fetch_array($reports)) {
                    
                    echo '<TR class="'. util_get_alt_row_color($i) .'"><TD>';

                    if ( $arr['scope'] == 'S' || (!$ath->userIsAdmin()&&($arr['scope'] == 'P')) ) {
		      echo $arr['report_id'];
		    } else {
		      echo '<A HREF="/tracker/admin/?func=report&group_id='.$group_id.
                            '&show_report=1&report_id='.$arr['report_id'].'&group_id='.$group_id.'&atid='.$ath->getID().'">'.
                            $arr['report_id'].'</A>';
                    }

                    echo "</td>\n<td>".$arr['name'].'</td>'.
                        "\n<td>".$arr['description'].'</td>'.
                        "\n<td align=\"center\">".$this->getScopeLabel($arr['scope']).'</td>'.
                        "\n<td align=\"center\">";
                    
                        $name = $arr['name'];
        
        			if ( $arr['scope'] == 'S' || (!$ath->userIsAdmin()&&($arr['scope'] == 'P')) ) {
	                    echo '-';
        			} else {
	                    echo '<A HREF="/tracker/admin/?func=report&group_id='.$group_id.
	                        '&atid='.$atid.'&delete_report=1&report_id='.$arr['report_id'].
	                        '" onClick="return confirm(\'Delete this Report : '.$name.'  ?\')">'.
	                            '<img src="'.util_get_image_theme("ic/trash.png").'" border="0"></A>';
					}
					        
                    echo '</td></tr>';
                    $i++;
                } 
                echo '</TABLE>';
            } else {
                echo '<p><h3>No artifact report defined yet.</h3>';
            }
        
            echo '<P> You can <A HREF="/tracker/admin/?func=report&group_id='.$group_id.
                '&atid='.$atid.'&new_report=1"><b>Create a New Tracker Report</b></A>.';
        }

        /**
         *  Display the report form
         *
         *  @return void
         */
        function createReportForm() {
                global $ath;
                
                $g = $ath->getGroup();
                $group_id = $g->getID();
                $atid = $ath->getID();

                $ath->adminHeader(array ('title'=>'Create A New Tracker Report',
                                    'help' => 'TrackerAdministration.html#TrackerReportSetting'));

		echo '<H2>Tracker \'<a href="/tracker/admin/?group_id='.$group_id.'&atid='.$atid.'">'.$ath->getName().'</a>\'  - Create a New Report </H2>';
    
            // display the table of all fields that can be included in the report
            $title_arr=array();
            $title_arr[]='Field Label';
            $title_arr[]='Description';
            $title_arr[]='Use as a Search Criteria';
            $title_arr[]='Rank on Search';
            $title_arr[]='Use as a Report Column';
            $title_arr[]='Rank on Report';      
            $title_arr[]='Column width (optional)';     
        
            echo'       
                <FORM ACTION="/tracker/admin/" METHOD="POST">
                   <INPUT TYPE="HIDDEN" NAME="func" VALUE="report">
                   <INPUT TYPE="HIDDEN" NAME="create_report" VALUE="y">
                   <INPUT TYPE="HIDDEN" NAME="group_id" VALUE="'.$group_id.'">
                   <INPUT TYPE="HIDDEN" NAME="atid" VALUE="'.$atid.'">
                   <INPUT TYPE="HIDDEN" NAME="post_changes" VALUE="y">
                   <B>Name:</B>
                   <INPUT TYPE="TEXT" NAME="rep_name" VALUE="" SIZE="20" MAXLENGTH="20">
                   &nbsp;&nbsp;&nbsp;&nbsp;<B>Scope: </B>';
            
            if ($ath->userIsAdmin())
                        echo '<SELECT NAME="rep_scope">
                                        <OPTION VALUE="I">Personal</OPTION>
                                        <OPTION VALUE="P">Project</OPTION>
                                        </SELECT>';
            else
                        echo 'Personal <INPUT TYPE="HIDDEN" NAME="rep_scope" VALUE="I">';
        
        
            echo ' <P>
                    <B>Description: </B>
                     <INPUT TYPE="TEXT" NAME="rep_desc" VALUE="" SIZE="50" MAXLENGTH="120">
                          <P>';
        
            echo html_build_list_table_top ($title_arr);
            $i=0;
            $aff = new ArtifactFieldFactory($ath);
            $fields = $aff->getAllUsedFields();
            while ( list($key, $field) = each($fields)) {
        
                // Do not show fields not used by the project
                if ( !$field->isUsed()) { continue; }
        
                // Do not show some special fields any way 
                if ($field->isSpecial()) { 
                    if ( ($field->getName() == 'group_id') ||
                         ($field->getName() == 'comment_type_id') )
                        { continue; }
                }
        
                $cb_search = 'CBSRCH_'.$field->getName();
                $cb_report = 'CBREP_'.$field->getName();
                $tf_search = 'TFSRCH_'.$field->getName();
                $tf_report = 'TFREP_'.$field->getName();
                $tf_colwidth = 'TFCW_'.$field->getName();
                echo '<TR class="'. util_get_alt_row_color($i) .'">';
                
                echo "\n<td>".$field->label.'</td>'.
                    "\n<td>".$field->description.'</td>'.
                    "\n<td align=\"center\">".'<input type="checkbox" name="'.$cb_search.'" value="1"></td>'.
                    "\n<td align=\"center\">".'<input type="text" name="'.$tf_search.'" value="" size="5" maxlen="5"></td>'.        
                    "\n<td align=\"center\">".'<input type="checkbox" name="'.$cb_report.'" value="1"></td>'.
                    "\n<td align=\"center\">".'<input type="text" name="'.$tf_report.'" value="" size="5" maxlen="5"></td>'.        
                    "\n<td align=\"center\">".'<input type="text" name="'.$tf_colwidth.'" value="" size="5" maxlen="5"></td>'.      
                    '</tr>';
                $i++;
            }
            echo '</TABLE>'.
                '<P><CENTER><INPUT TYPE="SUBMIT" NAME="submit" VALUE="SUBMIT"></CENTER>'.
                '</FORM>';
        
        }

        /**
         *  Display detail report form
         *
         *  @return void
         */
        function showReportForm() {
                global $ath;

                $g = $ath->getGroup();
                $group_id = $g->getID();
                $atid = $ath->getID();

                $ath->adminHeader(array ('title'=>'Modify '.$this->name.' Report for '.$ath->getName().' Tracker ',
                                    'help' => 'TrackerAdministration.html#TrackerReportSetting'));
                  
		echo '<H2>Tracker \'<a href="/tracker/admin/?group_id='.$group_id.'&atid='.$atid.'">'.$ath->getName().'</a>\'  - Modify Report \''.$this->name.'\'</H2>';
        
                    
            // display the table of all fields that can be included in the report
            // along with their current state in this report
            $title_arr=array();
            $title_arr[]='Field Label';
            $title_arr[]='Description';
            $title_arr[]='Use as a Search Criteria';
            $title_arr[]='Rank on Search';
            $title_arr[]='Use as a Report Column';
            $title_arr[]='Rank on Report';      
            $title_arr[]='Column width (optional)';     
                
            echo '<FORM ACTION="/tracker/admin/" METHOD="POST">
                   <INPUT TYPE="HIDDEN" NAME="func" VALUE="report">
                   <INPUT TYPE="HIDDEN" NAME="update_report" VALUE="y">
                   <INPUT TYPE="HIDDEN" NAME="atid" VALUE="'.$atid.'">
                   <INPUT TYPE="HIDDEN" NAME="group_id" VALUE="'.$group_id.'">
                   <INPUT TYPE="HIDDEN" NAME="report_id" VALUE="'.$this->report_id.'">
                   <INPUT TYPE="HIDDEN" NAME="post_changes" VALUE="y">
                   <B>Name: </B>
                   <INPUT TYPE="TEXT" NAME="rep_name" VALUE="'.$this->name.'" SIZE="20" MAXLENGTH="20">
                         &nbsp;&nbsp;&nbsp;&nbsp;<B>Scope: </B>';
            $scope = $this->scope;
            if ($ath->userIsAdmin())
                        echo '<SELECT NAME="rep_scope">
                                        <OPTION VALUE="I"'.($scope=='I' ? 'SELECTED':'').'>Personal</OPTION>
                                        <OPTION VALUE="P"'.($scope=='P' ? 'SELECTED':'').'>Project</OPTION>
                                        </SELECT>';
            else
                        echo ($scope=='P' ? 'Project':'Personal').
                            '<INPUT TYPE="HIDDEN" NAME="rep_scope" VALUE="'.$scope.'">';
        
            echo '
                    <P>
                    <B>Description:</B>
                    <INPUT TYPE="TEXT" NAME="rep_desc" VALUE="'.$this->description.'" SIZE="50" MAXLENGTH="120">
                          <P>';
        
            echo html_build_list_table_top ($title_arr);
            $i=0;
            $aff = new ArtifactFieldFactory($ath);
            $fields = $aff->getAllUsedFields();
            while ( list($key, $field) = each($fields) ) {
        
                // Do not show fields not used by the project
                if ( !$field->isUsed()) { continue; }
        
                // Do not show some special fields any way 
                if ($field->isSpecial()) { 
                    if ( ($field->getName() == 'group_id') ||
                         ($field->getName() == 'comment_type_id') )
                        { continue; }
                }
        
                $cb_search = 'CBSRCH_'.$field->getName();
                $cb_report = 'CBREP_'.$field->getName();
                $tf_search = 'TFSRCH_'.$field->getName();
                $tf_report = 'TFREP_'.$field->getName();
                $tf_colwidth = 'TFCW_'.$field->getName();
                
                $rep_field = $this->fields[$field->getName()];
                if (!$rep_field) {
                  $rep_field = new ArtifactReportField();
                }       
        
                $cb_search_chk = ($rep_field->isShowOnQuery() ? 'CHECKED':'');
                $cb_report_chk = ($rep_field->isShowOnResult() ? 'CHECKED':'');
                $tf_search_val = $rep_field->getPlaceQuery();
                $tf_report_val = $rep_field->getPlaceResult();
                $tf_colwidth_val = $rep_field->getColWidth();
        
                echo '<TR class="'. util_get_alt_row_color($i) .'">';
                
                echo "\n<td>".$field->getLabel().'</td>'.
                    "\n<td>".$field->getDescription().'</td>'.
                    "\n<td align=\"center\">".'<input type="checkbox" name="'.$cb_search.'" value="1" '.$cb_search_chk.' ></td>'.
                    "\n<td align=\"center\">".'<input type="text" name="'.$tf_search.'" value="'.$tf_search_val.'" size="5" maxlen="5"></td>'.      
                    "\n<td align=\"center\">".'<input type="checkbox" name="'.$cb_report.'" value="1" '.$cb_report_chk.' ></td>'.
                    "\n<td align=\"center\">".'<input type="text" name="'.$tf_report.'" value="'.$tf_report_val.'" size="5" maxlen="5"></td>'.      
                    "\n<td align=\"center\">".'<input type="text" name="'.$tf_colwidth.'" value="'.$tf_colwidth_val.'" size="5" maxlen="5"></td>'.          
                    '</tr>';
                $i++;
            }
            echo '</TABLE>'.
                '<P><CENTER><INPUT TYPE="SUBMIT" NAME="submit" VALUE="SUBMIT"></CENTER>'.
                '</FORM>';

        }


}

?>
