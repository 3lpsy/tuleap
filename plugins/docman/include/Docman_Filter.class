<?php
/*
 * Copyrightï¿½ STMicroelectronics, 2006
 * Originally written by Manuel VACELET, STMicroelectronics, 2006
 *
 * This file is a part of CodeX.
 *
 * CodeX is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * CodeX is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with CodeX; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 *
 * $Id$
 *
 */

/**
 *  Returns a date field
 * 
 *  @param value: initial value
 *  @param size: the field size
 *  @param maxlength: the max field size
 *  @param ro: if true, the field is read-only
 *
 *	@return	string
 */
function html_field_date($field_name='',$value='',$ro=false,$size='10',$maxlength='10',$form_name='artifact_form',$today=false) {
    if ($ro)
        $html = $value;
    else {
		$timeval = ($today ? 'null' : 'document.'.$form_name.'.'.$field_name.'.value'); 
	
		$html = '<INPUT TYPE="text" name="'.$field_name.
            '" size="'.$size.'" MAXLENGTH="'.$maxlength.'" VALUE="'.$value.'">'.
            '<a href="javascript:show_calendar(\'document.'.$form_name.'.'.$field_name.'\','.$timeval.',\''.util_get_css_theme().'\',\''.util_get_dir_image_theme().'\');">'.
            '<img src="'.util_get_image_theme("calendar/cal.png").'" width="16" height="16" border="0" alt="pick_date"></a>';
    }
    return($html);
}

class Docman_Filter {
    var $shortName;
    var $longName;
    var $message;
    var $isValid;
    var $v;

    function Docman_Filter($shortName) {
        $this->shortName = $shortName;
        $this->message = '';
        $this->isValid = null;
        $this->v = null;
    }

    /**
     * @return boolean Are current data valid or not
     */
    function validate() {
        return $this->isValid;
    }

    function setValue($v) {
        $this->v = $v;
    }

    function getValue() {
        return $this->v;
    }

    function getShortName() {
        return $this->shortName;
    }

    function setHtmlFieldName($name) {
        $this->longName = $name;
    }

    function toHtml() {

    }

    function getMessage() {
        return $this->message;
    }
    
    // abstract
    function getSqlClause() {
        
    }
}

class Docman_FilterInt extends Docman_Filter {

    function Docman_FilterInt($name) {
        parent::Docman_Filter($name);        
    }    

    function validate() {
        if($this->isValid === null) {
            $this->isValid = true;
            if(!is_numeric($this->v)) {
                $this->isValid = false;                
            }
        }
        return $this->isValid;
    }
}

class Docman_FilterOrdering extends Docman_FilterInt {
    var $sqlField;

    function Docman_FilterOrdering($name) {
        parent::Docman_FilterInt($name);
        $this->v = 0;
        $this->sqlField = '';
    }

    function validate() {
        if($this->isValid === null) {
            if($this->v == '') {
                $this->v = '0';
                $this->isValid = true;
            }
        }

        parent::validate();

        if(!$this->isValid) {
            $this->message = $GLOBALS['Language']->getText('plugin_docman', 'filters_ordering_message', $this->longName);
        }

        return parent::validate();
    }

    function toHtml() {
        $html = $this->longName.': <select name="'.$this->shortName.'">'."\n"
            .'<option value="0" '.(($this->v == '0') ? 'selected':'').'>'. $GLOBALS['Language']->getText('plugin_docman', 'filters_ordering_ascending') .'</option>'."\n"
            .'<option value="1" '.(($this->v == '1') ? 'selected':'').'>'. $GLOBALS['Language']->getText('plugin_docman', 'filters_ordering_descending') .'</option>'."\n"
            .'</select>'."\n";
        return $html;
    }

    function setSqlField($field) {
        $this->sqlField = $field;
    }

    function getSqlClause() {        
        $sql = $this->sqlField." ";
        if($this->v == '1')
            $sql .= 'ASC';
        else 
            $sql .= 'DESC';
        
        return $sql;
    }
}

class Docman_FilterDate extends Docman_Filter {
    var $sqlField;
    var $timestamp;
    var $op;
    var $formName;

    function Docman_FilterDate($name) {
        parent::Docman_Filter($name);
        $this->op = '';
        $this->timestamp = null;
        $this->formName = '';
    }

    function validate() {
        if($this->isValid === null) {
            $this->isValid = false;
            if($this->v == '') {
                $this->isValid = true;
            }
            elseif(preg_match('/[0-9]{4}-[0-9]{1,2}-[0-9]{1,2}/',$this->v)) {
                $this->isValid = true;                
            }
            else {
                $today = date("Y-n-j");
                $this->message = $GLOBALS['Language']->getText('plugin_docman', 'filters_date_message', array($this->longName, $today));
            }
        }
        return $this->isValid;
    }

    function setSqlOperator($op) {
        $this->op = $op;
    }

    function setSqlField($field) {
        $this->sqlField = $field;      
    }

    function _getTimestamp() {
        if($this->validate()) {
            if($this->timestamp === null && $this->v != '') {
                $a = explode('-', $this->v);
                $this->timestamp = mktime(0, 0, 0, $a[1], $a[2], $a[0]);
            }
        }
        return $this->timestamp;
    }

    function getSqlClause() {
        $ts = $this->_getTimestamp();
        if($ts !== null) {
            $sql = ' AND i.update_date '.$this->op.' '.$this->_getTimestamp();
        }
        else {
            $sql = '';
        }
        return $sql;
    }

    function setHtmlFormName($formName) {
        $this->formName = $formName;
    }

    function toHtml() {
        $v = '';
        if($this->validate()) {
            $v = $this->v;
        }
        $html = $this->longName.': '.html_field_date($this->shortName,$v,false,'10','10',$this->formName,false);

        return $html;
    }
}

?>
