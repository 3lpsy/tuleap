<?php
/* 
 * Copyright (c) STMicroelectronics, 2006. All Rights Reserved.
 *
 * Originally written by Nicolas Terray, 2006
 *
 * This file is a part of CodeX.
 *
 * CodeX is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * CodeX is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with CodeX; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 *
 * $Id$
 */
require_once('Docman_ItemDetailsSectionView.class');
require_once('Docman_VersionFactory.class');

class Docman_ItemDetailsSectionHistoryView extends Docman_ItemDetailsSectionView {
    var $logger;
    function Docman_ItemDetailsSectionHistoryView(&$item, $url, &$logger) {
        parent::Docman_ItemDetailsSectionView($item, $url, 'history', 'History');
        $this->logger =& $logger;
    }
    function getContent() {
        $content = '';
        if (is_a($this->item, 'Docman_File')) {
            $content .= '<h3>Versions</h3>';
            $version_factory =& new Docman_VersionFactory();
            if ($versions = $version_factory->getAllVersionForItem($this->item)) {
                if (count($versions)) {
                    $titles = array();
                    $titles[] = 'Version';
                    $titles[] = 'Date';
                    $titles[] = 'Author';
                    $titles[] = 'Label';
                    $titles[] = 'Changelog';
                    $content .= html_build_list_table_top($titles, false, false, false);
                    $odd_even = array('boxitem', 'boxitemalt');
                    $i = 0;
                    foreach ($versions as $key => $nop) {
                        $download = $this->item->getActionWhenUserClickOnTitle(array(
                            'default_url'    => $this->url,
                            'version_number' => $versions[$key]->getNumber()
                        ));
                        $user = $versions[$key]->getAuthorId() ? user_getname($versions[$key]->getAuthorId()) : 'Anonymous'; //TODO i18n
                        $content .= '<tr class="'. $odd_even[$i++ % count($odd_even)] .'">';
                        $content .= '<td><a href="'. $download .'">'. $versions[$key]->getNumber() .'</a></td>';
                        $content .= '<td>'. date('Y-m-d H:i:s', $versions[$key]->getDate())        .'</td>';
                        $content .= '<td>'. $user                                                  .'</td>';
                        $content .= '<td>'. $versions[$key]->getLabel()                            .'</td>';
                        $content .= '<td>'. $versions[$key]->getChangelog()                        .'</td>';
                        $content .= '</tr>';
                    }
                    $content .= '</table>';
                } else {
                    $content .= '<div>There is no version yet</div>';
                }
            } else {
                $content .= '<div>Error while searching for old versions for '. $this->item->getTitle() .'</div>';
            }
        }
        if ($this->logger) {
            $content .= $this->logger->fetchLogsForItem($this->item->getId());
        }
        return $content;
    }
}
?>
